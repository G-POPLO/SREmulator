using Microsoft.CodeAnalysis;
using SREmulator.SourceGeneration.Receivers;
using System.Collections.Generic;
using System.Text;

namespace SREmulator.SourceGeneration
{
    [Generator(LanguageNames.CSharp)]
    public class SRCharacterEventWarpGenerator : ISourceGenerator
    {
        public void Initialize(GeneratorInitializationContext context)
        {
            context.RegisterForSyntaxNotifications(() => new SRCharacterEventWarpKeysClassReceiver());
        }

        public void Execute(GeneratorExecutionContext context)
        {
            var receiver = (SRCharacterEventWarpKeysClassReceiver)context.SyntaxContextReceiver;
            var semanticModel = context.Compilation.GetSemanticModel(receiver.Keys.SyntaxTree);
            var keys = Microsoft.CodeAnalysis.CSharp.CSharpExtensions.GetDeclaredSymbol(semanticModel, receiver.Keys);
            List<(string Key, int Index, int Major, int Minor, string Up5, string Up41, string Up42, string Up43)> warps = new List<(string Key, int Index, int Major, int Minor, string Up5, string Up41, string Up42, string Up43)>();

            foreach (var member in keys.GetMembers())
            {
                var attributeDatas = member.GetAttributes(receiver.Attribute);

                foreach (var attributeData in attributeDatas)
                {
                    string key = (string)attributeData.ConstructorArguments[0].Value;
                    int index = (int)attributeData.ConstructorArguments[1].Value;
                    int major = (int)attributeData.ConstructorArguments[2].Value;
                    int minor = (int)attributeData.ConstructorArguments[3].Value;
                    string up5 = (string)attributeData.ConstructorArguments[4].Value;
                    string up41 = (string)attributeData.ConstructorArguments[5].Value;
                    string up42 = (string)attributeData.ConstructorArguments[6].Value;
                    string up43 = (string)attributeData.ConstructorArguments[7].Value;

                    warps.Add((key, index, major, minor, up5, up41, up42, up43));
                }
            }

            StringBuilder builder = new StringBuilder();
            builder.AppendLine("// <auto-generated/>");
            builder.AppendLine("using SREmulator.SRItems;");
            builder.AppendLine("namespace SREmulator.SRWarps.CharacterEventWarps");
            builder.AppendLine("{");
            builder.AppendLine("    partial class SRCharacterEventWarps");
            builder.AppendLine("    {");
            foreach (var warp in warps)
            {
                builder.AppendLine($"        private static SRCharacterEventWarp _{warp.Key}{warp.Index} = null;");
                builder.AppendLine($"        public static SRCharacterEventWarp {warp.Key}{warp.Index} => _{warp.Key}{warp.Index} ??= new {warp.Key}{warp.Index}();");
            }
            builder.AppendLine("    }");
            builder.AppendLine();

            foreach (var warp in warps)
            {
                builder.AppendLine($"    public sealed class {warp.Key}{warp.Index} : SRCharacterEventWarp");
                builder.AppendLine("    {");
                builder.AppendLine($"        public override SRVersion Version => SRVersion.Ver{warp.Major}p{warp.Minor};");
                builder.AppendLine($"        public override SRStar5Character UpStar5Character => SRCharacters.{warp.Up5};");
                builder.AppendLine($"        public override SRStar4Character UpStar4Character1 => SRCharacters.{warp.Up41};");
                builder.AppendLine($"        public override SRStar4Character UpStar4Character2 => SRCharacters.{warp.Up42};");
                builder.AppendLine($"        public override SRStar4Character UpStar4Character3 => SRCharacters.{warp.Up43};");
                builder.AppendLine("    }");
                builder.AppendLine();
            }

            builder.AppendLine("}");

            context.AddSource("SRCharacterEventWarps.g.cs", builder.ToString());
        }
    }
}
